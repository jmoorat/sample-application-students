language: java
jdk:
  - openjdk11

branches:
  only:
  - master
  - develop

addon:
  sonarcloud:
    organization: "jmoorat"
    token:
      secure: "5d1cbe2d0aea59a6c0ffbcd436cdbac1c2df5933"

jobs:
  include:
    -
      stage: "Build & Test"
      name: "Run mvn clean verify"
      script: mvn clean verify sonar:sonar -Pcoverage -Dsonar.projectKey=sample-application-students
    -
      stage: "Delivery"
      name: "Build and push API Docker image"
      if: branch = develop
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t sample-application-http-api-server ./sample-application-http-api-server
        - docker tag sample-application-http-api-server $DOCKER_USERNAME/sample-application-http-api-server
        - docker push $DOCKER_USERNAME/sample-application-http-api-server
    -
      name: "Build and push changelog job Docker image"
      if: branch = develop
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t sample-application-db-changelog-job ./sample-application-db-changelog-job
        - docker tag sample-application-db-changelog-job $DOCKER_USERNAME/sample-application-db-changelog-job
        - docker push $DOCKER_USERNAME/sample-application-db-changelog-job
  